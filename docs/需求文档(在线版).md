
# 需求文档 (for 在线版)

> version: 0.0

## TODO List

### 1 欢迎界面

`/home`

1. 要有跳转到 积分榜|创建房间|加入游戏 的链接

### 2 积分榜

`/topPlayers`

1. 根据 api 文档, **显示排名前7的玩家**, 按胜场降序

### 3 创建房间界面

`/god/admin`

1. 有选择人数的拖动条
2. 根据选择人数显示角色配置(狼人\*2, 村民\*1, 预言家\*1这样的)
3. 有提交按钮, 根据api向后端发送请求创建房间
4. 获得后端返回的**上帝token**, 暂时保存
5. 获得房间号, 生成**分享房间链接**`/player/login?room=<room id>`
6. 显示进入观战模式的按钮, 跳转到`/god/game?token=<token>&room=<room id>`

### 4 上帝观战界面

`/god/game?token=<token>&room=<room id>`

1. **每隔 2s** 根据api向后端发送游戏状态请求, 获取所有成员状态
2. 将状态展现到界面
3. 有按钮向后端发送请求, 提前结束游戏

### 5 玩家登录界面

`/player/login?room=<room id>`

1. 有**玩家名字, 房间号**的输入框, 提交进入游戏的按钮
2. 有**玩法说明按钮**, 显示一个提示弹窗, 按关闭按钮收回弹窗
3. 根据url中*可能有*的room id自动输入房间号
4. 获得后端的返回数据后, 显示分配到角色和简短的游戏提示, 确认后跳转到`/player?token=<token>&room=<room id>`界面

### 6 主要游戏界面

`/player?token=<token>&room=<room id>`

1. 根据 api, **每隔 2s 查询**当前游戏状态
2. 根据查询结果, 展示**所有玩家**的 名字|生死状态|是否为警长
3. 显示**自己**的 职业|生死状态|是否为警长|技能按钮(平时是disabled, 可发动时转为正常)|投票按钮(同上)
4. 根据白天|黑夜改变颜色(白底黑字|黑底白字), 有可能的话实现昼夜交替的特效
5. **游戏开始时是第 0 天晚上**, 提示天黑请闭眼, 各个玩家行动
6. 之后进入第 1 天白天, **先进行发言和警长选举**, 提示点击玩家头像进行投票. 之后进入正常白天流程
7. 夜晚流程为
   1. 根据api返回的 power 字段判断何时使用技能
   2. 出场顺序: 预言家, 守卫, 狼人, 女巫
   3. 预言家|狼人 选择目标后有短暂的**结果展示**, 结果在api返回值的`msg`字段里
   4. 守卫如果连续两晚保同一个人, msg字段将为`"retry"`, 重新释放技能
   5. 女巫: 无论是否有药, 都进入技能选择界面, 同时显示今晚的"nightResult"字段, 让女巫知道谁死了(此时有一个bug, 如果狼人杀了守卫保的人, 会显示没有人死去, 而女巫本不该知道这一点的, 后面再改吧)
   6. 女巫行动后, "time"将设置为"day", 进入白天
8. 白天流程为
   1. 根据"werewolfTarget", 显示死者
   2. 根据"saved/poisoned"显示被救活/毒杀的人
   3. 如果一个人同时被杀和救, 则不显示被杀或被救, 直接显示平安夜
   4. 暂时不考虑同时被守卫保护和女巫救的情况
   5. 如果猎人或警长死亡, 则让他们触发各自的技能(带走人, 决定警徽去向)
   6. 如果有上一步操作(第8.5点), 根据"hunterTarget", "sheriffTarget"显示猎人带走的人和警徽流
   7. 发言并投票
   8. 当所有人**投完票后**, 返回数据将被设置为`"time":"night"`由白天转到晚上. 根据"voteResult", 显示当天投票结果. 显示天黑请闭眼的提示
9.  当数据中"time"为"gameOver"时跳转到`/result?room=<room id>`界面, 进行结果清算

### 7 游戏结果展示界面

`/result?room=<room id>`

1. 根据 api 向后端发送请求, 获得游戏结果
2. 显示获胜方
3. 根据**获胜方**和**身份是否为狼人**显示胜利标志和失败标志
4. 显示每个玩家的 身份|死亡时间(或"存活")|胜场
5. 显示**积分榜**按钮, **返回主页**按钮和**再来一局**按钮

### 8 后端

1. 数据表

```go
// Room : model for room
type Room struct {
	gorm.Model
	RoomNumber     string `gorm:"type:char(8)"`
	GodToken       string
	Time           string `gorm:"type:varchar(20)"`
	Winner         string `gorm:"type:varchar(20)"`
	Day            int
	PlayerNum      int
	Players        []Player
	Voteresult     string
	WerewolfTarget string
	Huntertarget   string
	Sherifftarget  string
	Saved          string
	Poisoned       string
}

// Player : model for player
type Player struct {
	gorm.Model
	Name        string
	Token       string
	RoomID      uint
	Role        string `gorm:"type:varchar(20)"`
	Status      string `gorm:"type:varchar(20)"`
	Power       int
	IsSheriff   int
	KilledAt    int
	KilledBy    int
	ProtectedAt int
	VoteFor     string
	Cured       int
	Points      int
}
```

2. 逻辑
   1. 每天票完狼人后设置为黑夜
      1. 设置预言家为可行动, 如果预言家已死, 设置狼人行动
      2. 设置所有人的vote_for为空串
      3. 设置
   2. 如果预言家已死, 设置狼人行动, 否则进行查验, 查完设置预言家行动结束, 守卫开始行动
   3. 如果守卫已死, 设置守卫行动结束, 狼人开始行动. 否则进行守卫, 如果当前天数和protected_at相差一, 返回retry, 否则返回ok, 继续
   4. 所有活着的狼人的vote_for都设置后, 设置死者的killed_at, killed_by. 设置vote_for为空, 设置狼人行动结束, 女巫开始行动
   5. 如果女巫已死, 根据存活狼人数目和村民数目设置time为"day"或"gameOver", 否则女巫行动, 救人则设置status和cured, 杀人则设置killed_at, killed_by. 进入白天, 设置天数+=1
   6. 白天投票
      1. 如果for=sheriff, 等所有人(不是所有活人)投完后设置is_sheriff, vote_for为空
      2. 如果for=werewolf, 等所有**活人**投完后设置status, killed_at, killed-by, vote_for, 判断胜负, 设置黑夜
   7. 游戏结束后
      1. 设置胜场
      2. 设置房间状态
      3. 设置胜者
   8. 游戏开始时, 初始化所有玩家, 初始化房间

## 分工



## 注意事项

1. 注意拆分组件, 根据 vue 官方文档, 组件命名规范应该是`<父组件名><子组件项目>`, 首字母大写, 统一置于components目录下. 详见[官方文档](https://cn.vuejs.org/v2/style-guide/#%E7%B4%A7%E5%AF%86%E8%80%A6%E5%90%88%E7%9A%84%E7%BB%84%E4%BB%B6%E5%90%8D%E5%BC%BA%E7%83%88%E6%8E%A8%E8%8D%90)
2. 先用按照api文档的数据格式, 用假数据代替, 要查询时直接返回假数据, 等搭好了后端再改成发送网络请求